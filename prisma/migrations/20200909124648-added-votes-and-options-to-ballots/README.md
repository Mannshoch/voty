# Migration `20200909124648-added-votes-and-options-to-ballots`

This migration has been generated by Stefan N at 9/9/2020, 2:46:48 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."threads" ADD COLUMN "ref" text   

CREATE TABLE "public"."Options" (
"id" SERIAL,
"vote" integer   NOT NULL ,
"title" text   NOT NULL ,
"ballotId" integer   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."voted" (
"id" SERIAL,
"userId" integer   NOT NULL ,
"ballotId" integer   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."votes" (
"id" SERIAL,
"ballotId" integer   NOT NULL ,
"vote" integer   NOT NULL ,
"verify" text   ,
PRIMARY KEY ("id")
)

ALTER TABLE "public"."Options" ADD FOREIGN KEY ("ballotId")REFERENCES "public"."ballots"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."voted" ADD FOREIGN KEY ("userId")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."voted" ADD FOREIGN KEY ("ballotId")REFERENCES "public"."ballots"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."votes" ADD FOREIGN KEY ("ballotId")REFERENCES "public"."ballots"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200903093019-added-domain-to-teams..20200909124648-added-votes-and-options-to-ballots
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgres"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -65,34 +65,34 @@
   password String?
   gender   Gender  @default(UNKOWN)
-  role    Role    @default(STUDENT)
-  school  School? @relation(name: "SchoolUser", fields: [schoolId], references: [id])
-  team    Team?   @relation(name: "TeamMembers", fields: [teamId], references: [id])
-  teaches Team[]  @relation("Teacher")
+  role     Role    @default(STUDENT)
+  school   School? @relation(name: "SchoolUser", fields: [schoolId], references: [id])
+  team     Team?   @relation(name: "TeamMembers", fields: [teamId], references: [id])
+  teaches  Team[]  @relation("Teacher")
+  schoolId Int?
+  teamId   Int?
-  schoolId  Int?
-  teamId    Int?
-  createdAt DateTime @default(now()) @map(name: "created_at")
-  updatedAt DateTime @default(now()) @map(name: "updated_at")
-
   ballots     Ballot[]
   attachments Attachment[]
   threads     Thread[]
   reactions   Reaction[]
+  voted       Voted[]
+  createdAt DateTime @default(now()) @map(name: "created_at")
+  updatedAt DateTime @default(now()) @map(name: "updated_at")
   @@map(name: "users")
 }
 model VerificationRequest {
   id         Int      @default(autoincrement()) @id
   identifier String
   token      String   @unique
   expires    DateTime
-  createdAt  DateTime @default(now()) @map(name: "created_at")
-  updatedAt  DateTime @default(now()) @map(name: "updated_at")
+  createdAt DateTime @default(now()) @map(name: "created_at")
+  updatedAt DateTime @default(now()) @map(name: "updated_at")
   @@map(name: "verification_requests")
 }
 model Team {
@@ -163,14 +163,46 @@
   creatorId   Int
   thread      Thread?      @relation(fields: [threadId], references: [id])
   threadId    Int?
+  options Options[]
+  voted   Voted[]
+  votes   Votes[]
+
   createdAt DateTime @default(now()) @map(name: "created_at")
   updatedAt DateTime @default(now()) @map(name: "updated_at")
   @@map(name: "ballots")
 }
+model Options {
+  id       Int    @default(autoincrement()) @id
+  vote     Int
+  title    String
+  ballot   Ballot @relation(fields: [ballotId], references: [id])
+  ballotId Int
+}
+
+model Voted {
+  id       Int    @default(autoincrement()) @id
+  user     User   @relation(fields: [userId], references: [id])
+  userId   Int
+  ballot   Ballot @relation(fields: [ballotId], references: [id])
+  ballotId Int
+
+  @@map(name: "voted")
+}
+
+model Votes {
+  id       Int     @default(autoincrement()) @id
+  ballot   Ballot  @relation(fields: [ballotId], references: [id])
+  ballotId Int
+  vote     Int // 0 = abstention, 1-x = chosen option
+  verify   String? // encrypted verification token
+
+  @@map(name: "votes")
+}
+
 model Attachment {
   id       Int     @default(autoincrement()) @id
   file     String
   title    String  @default("")
@@ -195,15 +227,16 @@
   userId   Int
   parent   Thread? @relation(fields: [parentId], references: [id])
   parentId Int?
-  createdAt   DateTime     @default(now()) @map(name: "created_at")
-  updatedAt   DateTime     @default(now()) @map(name: "updated_at")
+  ref         String? // this can be used to reference a thread to content
   ballot      Ballot?
   children    Thread[]     @relation("ThreadToThread")
   reactions   Reaction[]
   attachments Attachment[]
+  createdAt DateTime @default(now()) @map(name: "created_at")
+  updatedAt DateTime @default(now()) @map(name: "updated_at")
   @@map(name: "threads")
 }
 model Reaction {
```


