# Migration `20200824120050-added-a-few-ballot-modules-incl--threads-and-attachments`

This migration has been generated by Stefan N at 8/24/2020, 2:00:50 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "Scope" AS ENUM ('PUBLIC', 'NATIONAL', 'CANTONAL', 'SCHOOL', 'TEAM');

CREATE TABLE "public"."ballots" (
"id" SERIAL,
"title" text  NOT NULL ,
"description" text  NOT NULL ,
"start" timestamp(3)  NOT NULL ,
"end" timestamp(3)  NOT NULL ,
"scope" "Scope" NOT NULL DEFAULT E'PUBLIC',
"canton" text   ,
"schoolId" integer   ,
"teamId" integer   ,
"creatorId" integer  NOT NULL ,
"threadId" integer   ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."attachments" (
"id" SERIAL,
"file" text  NOT NULL ,
"title" text  NOT NULL DEFAULT E'',
"userId" integer  NOT NULL ,
"ballotId" integer   ,
"threadId" integer   ,
"created_at" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updated_at" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id"))

CREATE TABLE "public"."threads" (
"id" SERIAL,
"title" text  NOT NULL DEFAULT E'',
"text" text  NOT NULL DEFAULT E'',
"userId" integer  NOT NULL ,
"parentId" integer   ,
"created_at" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updated_at" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id"))

CREATE TABLE "public"."reactions" (
"id" SERIAL,
"emoij" text  NOT NULL ,
"userId" integer  NOT NULL ,
"threadId" integer   ,
"created_at" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updated_at" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id"))

CREATE UNIQUE INDEX "ballots_threadId" ON "public"."ballots"("threadId")

ALTER TABLE "public"."ballots" ADD FOREIGN KEY ("schoolId")REFERENCES "public"."schools"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ballots" ADD FOREIGN KEY ("teamId")REFERENCES "public"."teams"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ballots" ADD FOREIGN KEY ("creatorId")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."ballots" ADD FOREIGN KEY ("threadId")REFERENCES "public"."threads"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."attachments" ADD FOREIGN KEY ("userId")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."attachments" ADD FOREIGN KEY ("ballotId")REFERENCES "public"."ballots"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."attachments" ADD FOREIGN KEY ("threadId")REFERENCES "public"."threads"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."threads" ADD FOREIGN KEY ("userId")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."threads" ADD FOREIGN KEY ("parentId")REFERENCES "public"."threads"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."reactions" ADD FOREIGN KEY ("userId")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."reactions" ADD FOREIGN KEY ("threadId")REFERENCES "public"."threads"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200823175241-remove-salt--as-it-is-not-needed..20200824120050-added-a-few-ballot-modules-incl--threads-and-attachments
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgres"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -72,8 +72,12 @@
   teamId    Int?
   createdAt DateTime @default(now()) @map(name: "created_at")
   updatedAt DateTime @default(now()) @map(name: "updated_at")
+  ballots     Ballot[]
+  attachments Attachment[]
+  threads     Thread[]
+  reactions   Reaction[]
   @@map(name: "users")
   Team Team[] @relation("Teacher")
 }
@@ -88,32 +92,112 @@
   @@map(name: "verification_requests")
 }
 model Team {
-  id        Int    @default(autoincrement()) @id
+  id        Int      @default(autoincrement()) @id
   name      String
-  school    School @relation(name: "SchoolTeam", fields: [schoolId], references: [id])
+  school    School   @relation(name: "SchoolTeam", fields: [schoolId], references: [id])
   schoolId  Int
-  teacher   User   @relation(name: "TeamTeacher", fields: [teacherId], references: [id])
+  teacher   User     @relation(name: "Teacher", fields: [teacherId], references: [id])
   teacherId Int
-  members   User[] @relation("TeamMembers")
-
+  members   User[]   @relation("TeamMembers")
+  Ballot    Ballot[]
   @@map(name: "teams")
-  User   User? @relation("Teacher", fields: [userId], references: [id])
+  User   User? @relation("TeamTeacher", fields: [userId], references: [id])
   userId Int?
 }
 model School {
-  id     Int    @default(autoincrement()) @id
-  name   String
-  domain String
+  id      Int      @default(autoincrement()) @id
+  name    String
+  domain  String
+  members User[]   @relation("SchoolUser")
+  teams   Team[]   @relation("SchoolTeam")
+  ballots Ballot[]
   @@map(name: "schools")
-  User User[] @relation("SchoolUser")
-  Team Team[] @relation("SchoolTeam")
 }
 model Domain {
   id       Int     @default(autoincrement()) @id
   name     String  @unique
   approved Boolean @default(false)
   @@map(name: "domains")
 }
+
+enum Scope {
+  PUBLIC // Open ballot
+  NATIONAL // Official national ballots
+  CANTONAL // Official canontal ballots
+  SCHOOL // School ballots
+  TEAM // class ballots
+}
+
+model Ballot {
+  id          Int      @default(autoincrement()) @id
+  title       String
+  description String
+  start       DateTime
+  end         DateTime
+
+  attachments Attachment[]
+  scope       Scope        @default(PUBLIC)
+  canton      String?
+  school      School?      @relation(fields: [schoolId], references: [id])
+  schoolId    Int?
+  team        Team?        @relation(fields: [teamId], references: [id])
+  teamId      Int?
+  creator     User         @relation(fields: [creatorId], references: [id])
+  creatorId   Int
+  thread      Thread?      @relation(fields: [threadId], references: [id])
+  threadId    Int?
+
+  @@map(name: "ballots")
+}
+
+model Attachment {
+  id       Int     @default(autoincrement()) @id
+  file     String
+  title    String  @default("")
+  user     User    @relation(fields: [userId], references: [id])
+  userId   Int
+  ballot   Ballot? @relation(fields: [ballotId], references: [id])
+  ballotId Int?
+  thread   Thread? @relation(fields: [threadId], references: [id])
+  threadId Int?
+
+  createdAt DateTime @default(now()) @map(name: "created_at")
+  updatedAt DateTime @default(now()) @map(name: "updated_at")
+
+  @@map(name: "attachments")
+}
+
+model Thread {
+  id       Int     @default(autoincrement()) @id
+  title    String  @default("")
+  text     String  @default("")
+  user     User    @relation(fields: [userId], references: [id])
+  userId   Int
+  parent   Thread? @relation(fields: [parentId], references: [id])
+  parentId Int?
+
+  createdAt   DateTime     @default(now()) @map(name: "created_at")
+  updatedAt   DateTime     @default(now()) @map(name: "updated_at")
+  ballot      Ballot?
+  children    Thread[]     @relation("ThreadToThread")
+  reactions   Reaction[]
+  attachments Attachment[]
+
+  @@map(name: "threads")
+}
+
+model Reaction {
+  id        Int      @default(autoincrement()) @id
+  emoij     String
+  user      User     @relation(fields: [userId], references: [id])
+  userId    Int
+  thread    Thread?  @relation(fields: [threadId], references: [id])
+  threadId  Int?
+  createdAt DateTime @default(now()) @map(name: "created_at")
+  updatedAt DateTime @default(now()) @map(name: "updated_at")
+
+  @@map(name: "reactions")
+}
```


