# Migration `20201010082501-moved-to-uuids-and-removed-accounts-and-sessions`

This migration has been generated by Stefan N at 10/10/2020, 10:25:01 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."attachments" DROP CONSTRAINT "attachments_ballot_id_fkey"

ALTER TABLE "public"."attachments" DROP CONSTRAINT "attachments_thread_id_fkey"

ALTER TABLE "public"."attachments" DROP CONSTRAINT "attachments_user_id_fkey"

ALTER TABLE "public"."ballots" DROP CONSTRAINT "ballots_creator_id_fkey"

ALTER TABLE "public"."ballots" DROP CONSTRAINT "ballots_school_id_fkey"

ALTER TABLE "public"."ballots" DROP CONSTRAINT "ballots_team_id_fkey"

ALTER TABLE "public"."ballots" DROP CONSTRAINT "ballots_thread_id_fkey"

ALTER TABLE "public"."options" DROP CONSTRAINT "options_ballot_id_fkey"

ALTER TABLE "public"."reactions" DROP CONSTRAINT "reactions_thread_id_fkey"

ALTER TABLE "public"."reactions" DROP CONSTRAINT "reactions_user_id_fkey"

ALTER TABLE "public"."schools" DROP CONSTRAINT "schools_domain_id_fkey"

ALTER TABLE "public"."teams" DROP CONSTRAINT "teams_domain_id_fkey"

ALTER TABLE "public"."teams" DROP CONSTRAINT "teams_school_id_fkey"

ALTER TABLE "public"."teams" DROP CONSTRAINT "teams_team_id_fkey"

ALTER TABLE "public"."threads" DROP CONSTRAINT "threads_parent_id_fkey"

ALTER TABLE "public"."threads" DROP CONSTRAINT "threads_user_id_fkey"

ALTER TABLE "public"."users" DROP CONSTRAINT "users_school_id_fkey"

ALTER TABLE "public"."users" DROP CONSTRAINT "users_team_id_fkey"

ALTER TABLE "public"."users" DROP CONSTRAINT "users_team_id_fkey1"

ALTER TABLE "public"."voted" DROP CONSTRAINT "voted_ballot_id_fkey"

ALTER TABLE "public"."voted" DROP CONSTRAINT "voted_user_id_fkey"

ALTER TABLE "public"."votes" DROP CONSTRAINT "votes_ballot_id_fkey"

ALTER TABLE "public"."attachments" DROP CONSTRAINT "attachments_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "user_id" SET DATA TYPE text ,
ALTER COLUMN "ballot_id" SET DATA TYPE text ,
ALTER COLUMN "thread_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "attachments_id_seq"

ALTER TABLE "public"."ballots" DROP CONSTRAINT "ballots_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "school_id" SET DATA TYPE text ,
ALTER COLUMN "team_id" SET DATA TYPE text ,
ALTER COLUMN "creator_id" SET DATA TYPE text ,
ALTER COLUMN "thread_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "ballots_id_seq"

ALTER TABLE "public"."domains" DROP CONSTRAINT "domains_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "domains_id_seq"

ALTER TABLE "public"."options" DROP CONSTRAINT "options_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "ballot_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "options_id_seq"

ALTER TABLE "public"."reactions" DROP CONSTRAINT "reactions_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "user_id" SET DATA TYPE text ,
ALTER COLUMN "thread_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "reactions_id_seq"

ALTER TABLE "public"."schools" DROP CONSTRAINT "schools_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "domain_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "schools_id_seq"

ALTER TABLE "public"."teams" DROP CONSTRAINT "teams_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "school_id" SET DATA TYPE text ,
ALTER COLUMN "team_id" SET DATA TYPE text ,
ALTER COLUMN "domain_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "teams_id_seq"

ALTER TABLE "public"."threads" DROP CONSTRAINT "threads_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "user_id" SET DATA TYPE text ,
ALTER COLUMN "parent_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "threads_id_seq"

ALTER TABLE "public"."users" DROP CONSTRAINT "users_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "school_id" SET DATA TYPE text ,
ALTER COLUMN "team_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "users_id_seq"

ALTER TABLE "public"."verification_requests" DROP CONSTRAINT "verification_requests_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "verification_requests_id_seq"

ALTER TABLE "public"."voted" DROP CONSTRAINT "voted_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "user_id" SET DATA TYPE text ,
ALTER COLUMN "ballot_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "voted_id_seq"

ALTER TABLE "public"."votes" DROP CONSTRAINT "votes_pkey",
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "ballot_id" SET DATA TYPE text ,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "votes_id_seq"

ALTER TABLE "public"."attachments" ADD FOREIGN KEY ("user_id")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."attachments" ADD FOREIGN KEY ("ballot_id")REFERENCES "public"."ballots"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."attachments" ADD FOREIGN KEY ("thread_id")REFERENCES "public"."threads"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ballots" ADD FOREIGN KEY ("school_id")REFERENCES "public"."schools"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ballots" ADD FOREIGN KEY ("team_id")REFERENCES "public"."teams"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ballots" ADD FOREIGN KEY ("creator_id")REFERENCES "public"."users"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ballots" ADD FOREIGN KEY ("thread_id")REFERENCES "public"."threads"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."options" ADD FOREIGN KEY ("ballot_id")REFERENCES "public"."ballots"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."reactions" ADD FOREIGN KEY ("user_id")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."reactions" ADD FOREIGN KEY ("thread_id")REFERENCES "public"."threads"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."schools" ADD FOREIGN KEY ("domain_id")REFERENCES "public"."domains"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."teams" ADD FOREIGN KEY ("school_id")REFERENCES "public"."schools"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."teams" ADD FOREIGN KEY ("team_id")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."teams" ADD FOREIGN KEY ("domain_id")REFERENCES "public"."domains"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."threads" ADD FOREIGN KEY ("user_id")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."threads" ADD FOREIGN KEY ("parent_id")REFERENCES "public"."threads"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."users" ADD FOREIGN KEY ("school_id")REFERENCES "public"."schools"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."users" ADD FOREIGN KEY ("team_id")REFERENCES "public"."teams"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."users" ADD FOREIGN KEY ("team_id")REFERENCES "public"."teams"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."voted" ADD FOREIGN KEY ("user_id")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."voted" ADD FOREIGN KEY ("ballot_id")REFERENCES "public"."ballots"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."votes" ADD FOREIGN KEY ("ballot_id")REFERENCES "public"."ballots"("id") ON DELETE CASCADE ON UPDATE CASCADE

DROP TABLE "public"."accounts"

DROP TABLE "public"."sessions"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200918064032-added-votes-schooltype---age-and--cantting..20201010082501-moved-to-uuids-and-removed-accounts-and-sessions
--- datamodel.dml
+++ datamodel.dml
@@ -1,45 +1,13 @@
 datasource db {
   provider = "postgres"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
 }
-model Account {
-  id                 Int       @default(autoincrement()) @id
-  compoundId         String    @unique @map(name: "compound_id")
-  userId             Int       @map(name: "user_id")
-  providerType       String    @map(name: "provider_type")
-  providerId         String    @map(name: "provider_id")
-  providerAccountId  String    @map(name: "provider_account_id")
-  refreshToken       String?   @map(name: "refresh_token")
-  accessToken        String?   @map(name: "access_token")
-  accessTokenExpires DateTime? @map(name: "access_token_expires")
-  createdAt          DateTime  @default(now()) @map(name: "created_at")
-  updatedAt          DateTime  @default(now()) @map(name: "updated_at")
-
-  @@index([providerAccountId], name: "providerAccountId")
-  @@index([providerId], name: "providerId")
-  @@index([userId], name: "userId")
-
-  @@map(name: "accounts")
-}
-
-model Session {
-  id           Int      @default(autoincrement()) @id
-  userId       Int      @map(name: "user_id")
-  expires      DateTime
-  sessionToken String   @unique @map(name: "session_token")
-  accessToken  String   @unique @map(name: "access_token")
-  createdAt    DateTime @default(now()) @map(name: "created_at")
-  updatedAt    DateTime @default(now()) @map(name: "updated_at")
-
-  @@map(name: "sessions")
-}
-
 enum Role {
   User
   Admin
   Student
@@ -54,9 +22,9 @@
   Other
 }
 model User {
-  id            Int       @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   name          String?
   email         String?   @unique
   emailVerified DateTime? @map(name: "email_verified")
   verified      Boolean?  @default(false)
@@ -71,10 +39,10 @@
   role     Role    @default(Student)
   school   School? @relation(fields: [schoolId], references: [id])
   team     Team?   @relation(fields: [teamId], references: [id])
   teaches  Team[]  @relation("Teacher")
-  schoolId Int?    @map(name: "school_id")
-  teamId   Int?    @map(name: "team_id")
+  schoolId String?    @map(name: "school_id")
+  teamId String?    @map(name: "team_id")
   ballots     Ballot[]
   attachments Attachment[]
   threads     Thread[]
@@ -82,14 +50,14 @@
   voted       Voted[]      @relation("VotedUser")
   createdAt DateTime @default(now()) @map(name: "created_at")
   updatedAt DateTime @default(now()) @map(name: "updated_at")
+  Team      Team?    @relation("TeamMembers", fields: [teamId], references: [id])
   @@map(name: "users")
-  Team Team? @relation("TeamMembers", fields: [teamId], references: [id])
 }
 model VerificationRequest {
-  id         Int      @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   identifier String
   token      String   @unique
   expires    DateTime
@@ -98,46 +66,46 @@
   @@map(name: "verification_requests")
 }
 model Team {
-  id     Int     @default(autoincrement()) @id
+  id     String       @id @default(cuid())
   name   String
   invite String? @unique
   year   Int? // in what year (roughly) were kids born (now - schoolyear - 5y)
   school    School   @relation(fields: [schoolId], references: [id])
-  schoolId  Int      @map(name: "school_id")
+  schoolId String      @map(name: "school_id")
   teacher   User     @relation(name: "Teacher", fields: [teacherId], references: [id])
-  teacherId Int      @map(name: "team_id")
+  teacherId String      @map(name: "team_id") // TODO: This field is wrongly named :-o
   members   User[]   @relation("TeamMembers")
   ballots   Ballot[]
   domain    Domain?  @relation(fields: [domainId], references: [id])
-  domainId  Int?     @map(name: "domain_id")
+  domainId String?     @map(name: "domain_id")
+  User User[]
   @@map(name: "teams")
-  User User[]
 }
 model School {
-  id      Int    @default(autoincrement()) @id
+  id      String       @id @default(cuid())
   name    String
   city    String @default("")
   canton  String @default("")
   zip     String @default("")
   address String @default("")
   type    String @default("")
   domain   Domain?  @relation(fields: [domainId], references: [id])
-  domainId Int?     @map(name: "domain_id")
+  domainId String?     @map(name: "domain_id")
   members  User[]
   teams    Team[]
   ballots  Ballot[]
   @@map(name: "schools")
 }
 model Domain {
-  id       Int     @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   name     String  @unique
   approved Boolean @default(false)
   schools School[]
@@ -162,9 +130,9 @@
   Closed // Ballot is already closed
 }
 model Ballot {
-  id          Int         @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   title       String
   description String
   body        String
   start       DateTime
@@ -172,15 +140,15 @@
   scope       BallotScope @default(Public)
   canton      String?
   school    School? @relation(fields: [schoolId], references: [id])
-  schoolId  Int?    @map(name: "school_id")
+  schoolId String?    @map(name: "school_id")
   team      Team?   @relation(fields: [teamId], references: [id])
-  teamId    Int?    @map(name: "team_id")
+  teamId String?    @map(name: "team_id")
   creator   User?   @relation(fields: [creatorId], references: [id])
-  creatorId Int?    @map(name: "creator_id")
+  creatorId String?    @map(name: "creator_id")
   thread    Thread? @relation(fields: [threadId], references: [id])
-  threadId  Int?    @map(name: "thread_id")
+  threadId String?    @map(name: "thread_id")
   options     Options[]
   voted       Voted[]      @relation("VotedBallot")
   votes       Votes[]
@@ -191,74 +159,74 @@
   @@map(name: "ballots")
 }
 model Options {
-  id    Int    @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   vote  Int
   title String
   ballot   Ballot @relation(fields: [ballotId], references: [id])
-  ballotId Int    @map(name: "ballot_id")
+  ballotId String    @map(name: "ballot_id")
   @@map(name: "options")
 }
 // todo: make user-relation 1:1
 model Voted {
-  id Int @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   signature String? // encrypted signature of the user
   user     User   @relation(name: "VotedUser", fields: [userId], references: [id])
-  userId   Int    @map(name: "user_id")
+  userId String    @map(name: "user_id")
   ballot   Ballot @relation(name: "VotedBallot", fields: [ballotId], references: [id])
-  ballotId Int    @map(name: "ballot_id")
+  ballotId String    @map(name: "ballot_id")
   @@map(name: "voted")
 }
 // TODO: rename to singular.. but it's dangerous with automigration
 model Votes {
-  id         Int     @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   vote       Int // 0 = abstention, 1-x = chosen option
   verify     String? // encrypted verification token
   year       Int?
   canton     String?
   schooltype String?
   ballot   Ballot @relation(fields: [ballotId], references: [id])
-  ballotId Int    @map(name: "ballot_id")
+  ballotId String    @map(name: "ballot_id")
   @@map(name: "votes")
 }
 model Attachment {
-  id    Int    @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   file  String
   title String @default("")
   user     User    @relation(fields: [userId], references: [id])
-  userId   Int     @map(name: "user_id")
+  userId String     @map(name: "user_id")
   ballot   Ballot? @relation(fields: [ballotId], references: [id])
-  ballotId Int?    @map(name: "ballot_id")
+  ballotId String?    @map(name: "ballot_id")
   thread   Thread? @relation(fields: [threadId], references: [id])
-  threadId Int?    @map(name: "thread_id")
+  threadId String?    @map(name: "thread_id")
   createdAt DateTime @default(now()) @map(name: "created_at")
   updatedAt DateTime @default(now()) @map(name: "updated_at")
   @@map(name: "attachments")
 }
 model Thread {
-  id    Int     @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   title String  @default("")
   text  String  @default("")
   ref   String? // this can be used to reference a thread to content
   user     User    @relation(fields: [userId], references: [id])
-  userId   Int     @map(name: "user_id")
+  userId String     @map(name: "user_id")
   parent   Thread? @relation(fields: [parentId], references: [id])
-  parentId Int?    @map(name: "parent_id")
+  parentId String?    @map(name: "parent_id")
   ballot      Ballot?
   children    Thread[]     @relation("ThreadToThread")
   reactions   Reaction[]
@@ -269,15 +237,15 @@
   @@map(name: "threads")
 }
 model Reaction {
-  id    Int    @default(autoincrement()) @id
+  id            String       @id @default(cuid())
   emoij String
   user     User    @relation(fields: [userId], references: [id])
-  userId   Int     @map(name: "user_id")
+  userId String     @map(name: "user_id")
   thread   Thread? @relation(fields: [threadId], references: [id])
-  threadId Int?    @map(name: "thread_id")
+  threadId String?    @map(name: "thread_id")
   createdAt DateTime @default(now()) @map(name: "created_at")
   updatedAt DateTime @default(now()) @map(name: "updated_at")
   @@map(name: "reactions")
```


