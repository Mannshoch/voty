# Migration `20200823081745-added-roles--schools--teams-and-relations`

This migration has been generated by Stefan N at 8/23/2020, 10:17:45 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "Role" AS ENUM ('STUDENT', 'TEACHER', 'ADMIN');

CREATE TABLE "public"."teams" (
"id" SERIAL,
"name" text  NOT NULL ,
"schoolId" integer  NOT NULL ,
"teacherId" integer  NOT NULL ,
"userId" integer   ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."schools" (
"id" SERIAL,
"name" text  NOT NULL ,
"domain" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."domains" (
"id" SERIAL,
"name" text  NOT NULL ,
"approved" boolean  NOT NULL DEFAULT false,
PRIMARY KEY ("id"))

ALTER TABLE "public"."users" ADD COLUMN "role" "Role" NOT NULL DEFAULT E'STUDENT',
ADD COLUMN "schoolId" integer   ,
ADD COLUMN "teamId" integer   ;

CREATE UNIQUE INDEX "domains.name_unique" ON "public"."domains"("name")

ALTER TABLE "public"."teams" ADD FOREIGN KEY ("schoolId")REFERENCES "public"."schools"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."teams" ADD FOREIGN KEY ("teacherId")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."teams" ADD FOREIGN KEY ("userId")REFERENCES "public"."users"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."users" ADD FOREIGN KEY ("schoolId")REFERENCES "public"."schools"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."users" ADD FOREIGN KEY ("teamId")REFERENCES "public"."teams"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200807054749-init..20200823081745-added-roles--schools--teams-and-relations
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgres"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -38,18 +38,32 @@
   @@map(name: "sessions")
 }
+enum Role {
+  STUDENT
+  TEACHER
+  ADMIN
+}
+
 model User {
   id            Int       @default(autoincrement()) @id
   name          String?
   email         String?   @unique
   emailVerified DateTime? @map(name: "email_verified")
   image         String?
-  createdAt     DateTime  @default(now()) @map(name: "created_at")
-  updatedAt     DateTime  @default(now()) @map(name: "updated_at")
+  role          Role      @default(STUDENT)
+  school        School?   @relation(name: "SchoolUser", fields: [schoolId], references: [id])
+  team          Team?     @relation(name: "TeamMembers", fields: [teamId], references: [id])
+  teaches       Team[]    @relation("TeamTeacher")
+  schoolId  Int?
+  teamId    Int?
+  createdAt DateTime @default(now()) @map(name: "created_at")
+  updatedAt DateTime @default(now()) @map(name: "updated_at")
+
   @@map(name: "users")
+  Team Team[] @relation("Teacher")
 }
 model VerificationRequest {
   id         Int      @default(autoincrement()) @id
@@ -60,4 +74,34 @@
   updatedAt  DateTime @default(now()) @map(name: "updated_at")
   @@map(name: "verification_requests")
 }
+
+model Team {
+  id        Int    @default(autoincrement()) @id
+  name      String
+  school    School @relation(name: "SchoolTeam", fields: [schoolId], references: [id])
+  schoolId  Int
+  teacher   User   @relation(name: "TeamTeacher", fields: [teacherId], references: [id])
+  teacherId Int
+  members   User[] @relation("TeamMembers")
+
+  @@map(name: "teams")
+  User   User? @relation("Teacher", fields: [userId], references: [id])
+  userId Int?
+}
+
+model School {
+  id     Int    @default(autoincrement()) @id
+  name   String
+  domain String
+  @@map(name: "schools")
+  User User[] @relation("SchoolUser")
+  Team Team[] @relation("SchoolTeam")
+}
+
+model Domain {
+  id       Int     @default(autoincrement()) @id
+  name     String  @unique
+  approved Boolean @default(false)
+  @@map(name: "domains")
+}
```


